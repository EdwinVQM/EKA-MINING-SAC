<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding: 12px; }
    .group-card { border-left-width: 6px; }
    .g1 { border-left-color: #0d6efd20; } /* azul tenue */
    .g2 { border-left-color: #20c99720; } /* verde menta tenue */
    .g3 { border-left-color: #fd7e1420; } /* naranja tenue */
    .g4 { border-left-color: #6f42c120; } /* violeta tenue */
    .sticky-actions { position: sticky; bottom: 0; background: #fff; padding-top: 8px; }
  </style>
</head>
<body>
  <h5 class="mb-3">Cotizaciones</h5>

  <!-- Botón de Probar conexión -->
  <div class="d-flex gap-2 mb-3">
    <button id="btnPing" class="btn btn-outline-primary btn-sm">
      Probar conexión
    </button>
    <div id="pingStatus" class="align-self-center small text-muted">Cargando Info…</div>
  </div>

  <!-- Acordeón de grupos -->
  <div class="accordion" id="groupsAcc">

    <!-- Grupo 1: Cliente -->
    <div class="accordion-item group-card g1">
      <h2 class="accordion-header" id="g1h">
        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#g1c" aria-expanded="true" aria-controls="g1c">
          Cliente
        </button>
      </h2>
      <div id="g1c" class="accordion-collapse collapse show" aria-labelledby="g1h" data-bs-parent="#groupsAcc">
        <div class="accordion-body">
          <div class="mb-2">
            <label class="form-label">Nuevo Cliente</label>
            <div class="input-group">
              <input id="cliNombre" class="form-control form-control-sm" placeholder="p.ej. Nexa" />
              <button id="btnAddCliente" class="btn btn-primary btn-sm">Guardar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grupo 2: Zona de trabajo + Solicitante -->
    <div class="accordion-item group-card g2">
      <h2 class="accordion-header" id="g2h">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#g2c" aria-expanded="false" aria-controls="g2c">
          Zona de Trabajo & Solicitante
        </button>
      </h2>
      <div id="g2c" class="accordion-collapse collapse" aria-labelledby="g2h" data-bs-parent="#groupsAcc">
        <div class="accordion-body">
          <!-- Zona de trabajo -->
          <div class="mb-3">
            <label class="form-label">Nueva Zona de Trabajo</label>
            <div class="row g-2">
              <div class="col-6">
                <input id="zonaCliente" class="form-control form-control-sm" placeholder="Cliente (p.ej. Nexa)" />
              </div>
              <div class="col-6">
                <input id="zonaUnidad" class="form-control form-control-sm" placeholder="Unidad / Zona" />
              </div>
            </div>
            <div class="mt-2">
              <button id="btnAddZona" class="btn btn-success btn-sm">Guardar zona</button>
            </div>
          </div>
          <hr>
          <!-- Solicitante -->
          <div class="mb-2">
            <label class="form-label">Nuevo Solicitante</label>
            <div class="row g-2">
              <div class="col-12">
                <input id="solNombre" class="form-control form-control-sm" placeholder="Nombre" />
              </div>
              <div class="col-8">
                <input id="solCorreo" class="form-control form-control-sm" placeholder="Correo" />
              </div>
              <div class="col-4">
                <input id="solTel" class="form-control form-control-sm" placeholder="Teléfono" />
              </div>
            </div>
            <div class="mt-2">
              <button id="btnAddSolicitante" class="btn btn-success btn-sm">Guardar solicitante</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Grupo 3: Industria -->
    <div class="accordion-item group-card g3">
      <h2 class="accordion-header" id="g3h">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#g3c" aria-expanded="false" aria-controls="g3c">
          Industria
        </button>
      </h2>
      <div id="g3c" class="accordion-collapse collapse" aria-labelledby="g3h" data-bs-parent="#groupsAcc">
        <div class="accordion-body">
          <div class="input-group">
            <input id="indNombre" class="form-control form-control-sm" placeholder="Nueva industria" />
            <button id="btnAddIndustria" class="btn btn-warning btn-sm">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Grupo 4: Personal EKA -->
    <div class="accordion-item group-card g4">
      <h2 class="accordion-header" id="g4h">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#g4c" aria-expanded="false" aria-controls="g4c">
          Personal EKA
        </button>
      </h2>
      <div id="g4c" class="accordion-collapse collapse" aria-labelledby="g4h" data-bs-parent="#groupsAcc">
        <div class="accordion-body">
          <div class="row g-2">
            <div class="col-12"><input id="perNombre" class="form-control form-control-sm" placeholder="Nombre" /></div>
            <div class="col-7"><input id="perCorreo" class="form-control form-control-sm" placeholder="Correo" /></div>
            <div class="col-5"><input id="perTel"    class="form-control form-control-sm" placeholder="Teléfono" /></div>
            <div class="col-12"><input id="perRol"   class="form-control form-control-sm" placeholder="Rol" /></div>
          </div>
          <div class="mt-2">
            <button id="btnAddPersonal" class="btn btn-secondary btn-sm">Guardar Personal</button>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- /accordion -->

  <!-- Toasts -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080">
    <div id="toastOk" class="toast align-items-center text-bg-success border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastOkMsg">Guardado.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
    <div id="toastErr" class="toast align-items-center text-bg-danger border-0" role="alert">
      <div class="d-flex">
        <div class="toast-body" id="toastErrMsg">Error.</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Helpers UI
    const okToast = new bootstrap.Toast(document.getElementById('toastOk'));
    const errToast = new bootstrap.Toast(document.getElementById('toastErr'));
    const ok = (msg) => { document.getElementById('toastOkMsg').textContent = msg || 'OK'; okToast.show(); };
    const err = (msg) => { document.getElementById('toastErrMsg').textContent = msg || 'Error'; errToast.show(); };

    const disableWhile = async (btn, fn) => {
      btn.disabled = true;
      btn.dataset.prevText = btn.textContent;
      btn.textContent = 'Guardando…';
      try { await fn(); }
      finally { btn.disabled = false; btn.textContent = btn.dataset.prevText; }
    };

    // Probar conexión
    const pingEl = document.getElementById('pingStatus');
    document.getElementById('btnPing').addEventListener('click', () => {
      pingEl.textContent = 'Cargando Info…';
      google.script.run
        .withSuccessHandler(r => {
          pingEl.textContent = `Conectado a "${r.spreadsheet}". Hojas: ${r.data.map(d=>d.sheet+':'+d.rows).join(', ')}`;
        })
        .withFailureHandler(e => {
          pingEl.textContent = 'Error al conectar';
          err(e && e.message ? e.message : String(e));
        })
        .getInitData();
    });

    // Botones: llamadas al servidor
    document.getElementById('btnAddCliente').addEventListener('click', (ev) => {
      const btn = ev.currentTarget;
      const nombre = document.getElementById('cliNombre').value;
      disableWhile(btn, () => new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(() => { ok('Cliente guardado'); document.getElementById('cliNombre').value = ''; resolve(); })
          .withFailureHandler(e => { err(e.message || String(e)); resolve(); })
          .addCliente(nombre);
      }));
    });

    document.getElementById('btnAddZona').addEventListener('click', (ev) => {
      const btn = ev.currentTarget;
      const cliente = document.getElementById('zonaCliente').value;
      const unidad  = document.getElementById('zonaUnidad').value;
      disableWhile(btn, () => new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(() => { ok('Zona guardada'); document.getElementById('zonaUnidad').value=''; resolve(); })
          .withFailureHandler(e => { err(e.message || String(e)); resolve(); })
          .addZona(cliente, unidad);
      }));
    });

    document.getElementById('btnAddSolicitante').addEventListener('click', (ev) => {
      const btn = ev.currentTarget;
      const nombre = document.getElementById('solNombre').value;
      const correo = document.getElementById('solCorreo').value;
      const tel    = document.getElementById('solTel').value;
      disableWhile(btn, () => new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(() => { ok('Solicitante guardado'); document.getElementById('solNombre').value=''; document.getElementById('solCorreo').value=''; document.getElementById('solTel').value=''; resolve(); })
          .withFailureHandler(e => { err(e.message || String(e)); resolve(); })
          .addSolicitante(nombre, correo, tel);
      }));
    });

    document.getElementById('btnAddIndustria').addEventListener('click', (ev) => {
      const btn = ev.currentTarget;
      const nombre = document.getElementById('indNombre').value;
      disableWhile(btn, () => new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(() => { ok('Industria guardada'); document.getElementById('indNombre').value=''; resolve(); })
          .withFailureHandler(e => { err(e.message || String(e)); resolve(); })
          .addIndustria(nombre);
      }));
    });

    document.getElementById('btnAddPersonal').addEventListener('click', (ev) => {
      const btn = ev.currentTarget;
      const n = document.getElementById('perNombre').value;
      const c = document.getElementById('perCorreo').value;
      const t = document.getElementById('perTel').value;
      const r = document.getElementById('perRol').value;
      disableWhile(btn, () => new Promise((resolve) => {
        google.script.run
          .withSuccessHandler(() => { ok('Personal guardado'); ['perNombre','perCorreo','perTel','perRol'].forEach(id=>document.getElementById(id).value=''); resolve(); })
          .withFailureHandler(e => { err(e.message || String(e)); resolve(); })
          .addPersonalEKA(n, c, t, r);
      }));
    });

    // Al abrir, intenta ping una vez (opcional)
    document.getElementById('btnPing').click();
  </script>
</body>
</html>


