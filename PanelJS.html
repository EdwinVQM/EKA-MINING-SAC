<script>
  // Toast helpers
  const okToast = () => new bootstrap.Toast(document.getElementById('toastOk'));
  const errToast = () => new bootstrap.Toast(document.getElementById('toastErr'));
  const setOk = (m) => { document.getElementById('toastOkMsg').textContent = m||'OK'; okToast().show(); };
  const setErr = (m) => { document.getElementById('toastErrMsg').textContent = m||'Error'; errToast().show(); };

  // Disable helper
  const disableWhile = async (btn, fn) => {
    btn.disabled = true;
    const prev = btn.textContent; btn.textContent = 'Guardando…';
    try { await fn(); } finally { btn.disabled = false; btn.textContent = prev; }
  };

  // Ping
  const pingEl = document.getElementById('pingStatus');
  document.getElementById('btnPing').addEventListener('click', () => {
    pingEl.textContent = 'Cargando Info…';
    google.script.run
      .withSuccessHandler(r => {
        pingEl.textContent = `Conectado a "${r.spreadsheet}". Hojas: ${r.data.map(d=>d.sheet+':'+d.rows).join(', ')}`;
      })
      .withFailureHandler(e => {
        pingEl.textContent = 'Error al conectar';
        setErr(e && e.message ? e.message : String(e));
      })
      .getInitData();
  });

  // Eventos
  document.getElementById('btnAddCliente').addEventListener('click', (ev) => {
    const btn = ev.currentTarget;
    const v = document.getElementById('cliNombre').value;
    disableWhile(btn, () => new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(() => { setOk('Cliente guardado'); document.getElementById('cliNombre').value=''; resolve(); })
        .withFailureHandler(e => { setErr(e.message || String(e)); resolve(); })
        .addCliente(v);
    }));
  });

  document.getElementById('btnAddZona').addEventListener('click', (ev) => {
    const btn = ev.currentTarget;
    const c = document.getElementById('zonaCliente').value;
    const u = document.getElementById('zonaUnidad').value;
    disableWhile(btn, () => new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(() => { setOk('Zona guardada'); document.getElementById('zonaUnidad').value=''; resolve(); })
        .withFailureHandler(e => { setErr(e.message || String(e)); resolve(); })
        .addZona(c, u);
    }));
  });

  document.getElementById('btnAddSolicitante').addEventListener('click', (ev) => {
    const btn = ev.currentTarget;
    const n = document.getElementById('solNombre').value;
    const c = document.getElementById('solCorreo').value;
    const t = document.getElementById('solTel').value;
    disableWhile(btn, () => new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(() => { setOk('Solicitante guardado'); ['solNombre','solCorreo','solTel'].forEach(id=>document.getElementById(id).value=''); resolve(); })
        .withFailureHandler(e => { setErr(e.message || String(e)); resolve(); })
        .addSolicitante(n, c, t);
    }));
  });

  document.getElementById('btnAddIndustria').addEventListener('click', (ev) => {
    const btn = ev.currentTarget;
    const v = document.getElementById('indNombre').value;
    disableWhile(btn, () => new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(() => { setOk('Industria guardada'); document.getElementById('indNombre').value=''; resolve(); })
        .withFailureHandler(e => { setErr(e.message || String(e)); resolve(); })
        .addIndustria(v);
    }));
  });

  document.getElementById('btnAddPersonal').addEventListener('click', (ev) => {
    const btn = ev.currentTarget;
    const n = document.getElementById('perNombre').value;
    const c = document.getElementById('perCorreo').value;
    const t = document.getElementById('perTel').value;
    const r = document.getElementById('perRol').value;
    disableWhile(btn, () => new Promise((resolve) => {
      google.script.run
        .withSuccessHandler(() => { setOk('Personal guardado'); ['perNombre','perCorreo','perTel','perRol'].forEach(id=>document.getElementById(id).value=''); resolve(); })
        .withFailureHandler(e => { setErr(e.message || String(e)); resolve(); })
        .addPersonalEKA(n, c, t, r);
    }));
  });

  // Disparo inicial opcional
  document.getElementById('btnPing').click();
</script>
